<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focus System | JonesRobM</title>
    <!-- React & Babel for Browser Parsing -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-[#0B0B0B]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // Lucide Icon Component Wrapper
        const Icon = ({ name, size = 18, className = "" }) => {
            const [svg, setSvg] = useState("");
            useEffect(() => {
                if (window.lucide) {
                    const iconSvg = window.lucide.createIcons();
                }
            }, []);
            // Simple fallback for single-file CDN usage: we use a standard span with data-lucide
            return <i data-lucide={name} style={{width: size, height: size}} className={className}></i>;
        };

        const App = () => {
            const apiKey = ""; // Set at runtime or via environment
            const BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

            const MODES = {
                FOCUS: { id: 'FOCUS', label: 'Focus Deep', time: 25 * 60, desc: 'High-intensity cognitive work.' },
                SHORT_BREAK: { id: 'SHORT_BREAK', label: 'Short Rest', time: 5 * 60, desc: 'Brief physiological reset.' },
                LONG_BREAK: { id: 'LONG_BREAK', label: 'Deep Reset', time: 15 * 60, desc: 'Extended recovery.' }
            };

            const [mode, setMode] = useState('FOCUS');
            const [timeLeft, setTimeLeft] = useState(MODES.FOCUS.time);
            const [isActive, setIsActive] = useState(false);
            const [points, setPoints] = useState(() => Number(localStorage.getItem('focus_points')) || 0);
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('focus_history')) || []);
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('focus_tasks')) || []);
            const [newTask, setNewTask] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiCoachResponse, setAiCoachResponse] = useState(null);
            const [showPreFlight, setShowPreFlight] = useState(false);
            const timerRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('focus_points', points);
                localStorage.setItem('focus_history', JSON.stringify(history));
                localStorage.setItem('focus_tasks', JSON.stringify(tasks));
                if (window.lucide) window.lucide.createIcons();
            }, [points, history, tasks]);

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const callGemini = async (prompt) => {
                setIsAiLoading(true);
                try {
                    const response = await fetch(`${BASE_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: "High-performance coach. Stoic. Concise." }] }
                        })
                    });
                    const data = await response.json();
                    setIsAiLoading(false);
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (err) {
                    setIsAiLoading(false);
                    return null;
                }
            };

            const generateProtocol = async () => {
                const result = await callGemini("Provide a 2-sentence stoic protocol for a deep focus session.");
                if (result) setAiCoachResponse(result);
            };

            useEffect(() => {
                if (isActive && timeLeft > 0) {
                    timerRef.current = setInterval(() => setTimeLeft(p => p - 1), 1000);
                } else if (timeLeft === 0) {
                    const earned = Math.floor(MODES[mode].time / 60);
                    setPoints(p => p + earned);
                    setHistory(prev => [...prev, mode]);
                    setIsActive(false);
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [isActive, timeLeft]);

            return (
                <div className="min-h-screen bg-[#0B0B0B] text-zinc-400 p-4 md:p-8 flex flex-col items-center select-none overscroll-none">
                    <div className="w-full max-w-md space-y-8">
                        {/* Header */}
                        <div className="flex justify-between items-end border-b border-zinc-900 pb-6">
                            <div>
                                <h1 className="text-zinc-100 font-medium tracking-tight">Focus System</h1>
                                <p className="text-[9px] text-zinc-600 uppercase tracking-[0.3em] mt-1">Integrity // v2.4</p>
                            </div>
                            <div className="text-right">
                                <span className="text-2xl font-light tabular-nums text-zinc-300">{points}</span>
                            </div>
                        </div>

                        {/* AI Protocol */}
                        <div className="bg-zinc-900/20 border border-zinc-900 rounded-2xl p-4 min-h-[80px] flex flex-col justify-center">
                            {aiCoachResponse ? (
                                <p className="text-xs italic text-zinc-300 leading-relaxed">"{aiCoachResponse}"</p>
                            ) : (
                                <div className="flex justify-between items-center">
                                    <span className="text-xs text-zinc-600 uppercase tracking-widest">Protocol Offline</span>
                                    <button onClick={generateProtocol} className="text-[10px] bg-zinc-800 px-3 py-1 rounded text-zinc-400">
                                        {isAiLoading ? "..." : "Engage AI"}
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Timer */}
                        <div className="bg-zinc-900/10 border border-zinc-900 rounded-[2.5rem] py-12 text-center relative overflow-hidden">
                            {showPreFlight && (
                                <div className="absolute inset-0 bg-zinc-950/98 z-20 flex flex-col items-center justify-center p-6 text-center space-y-4">
                                    <p className="text-xs uppercase tracking-widest text-zinc-400">Pre-Flight Check</p>
                                    <p className="text-[10px] text-zinc-600">Notifications muted? Environment cleared?</p>
                                    <button onClick={() => {setShowPreFlight(false); setIsActive(true);}} className="bg-white text-black px-6 py-2 rounded-lg text-xs font-bold uppercase">Confirm</button>
                                </div>
                            )}
                            <div className="flex justify-center gap-2 mb-8">
                                {Object.keys(MODES).map(m => (
                                    <button key={m} onClick={() => {setMode(m); setTimeLeft(MODES[m].time); setIsActive(false);}}
                                        className={`text-[9px] uppercase font-bold tracking-widest px-3 py-1.5 rounded-md transition-all ${mode === m ? 'bg-zinc-800 text-white' : 'text-zinc-600'}`}>
                                        {MODES[m].label}
                                    </button>
                                ))}
                            </div>
                            <div className="text-[20vw] md:text-8xl font-extralight text-zinc-100 tabular-nums tracking-tighter mb-8">
                                {formatTime(timeLeft)}
                            </div>
                            <div className="flex justify-center gap-8 items-center">
                                <button onClick={() => setTimeLeft(MODES[mode].time)} className="text-zinc-700"><i data-lucide="rotate-ccw"></i></button>
                                <button onClick={() => mode === 'FOCUS' && !isActive ? setShowPreFlight(true) : setIsActive(!isActive)} 
                                    className="w-20 h-20 rounded-2xl bg-zinc-100 text-black flex items-center justify-center active:scale-95 transition-transform">
                                    <i data-lucide={isActive ? "pause" : "play"}></i>
                                </button>
                                <button onClick={() => setTimeLeft(0)} className="text-zinc-700"><i data-lucide="skip-forward"></i></button>
                            </div>
                        </div>

                        {/* Tasks */}
                        <div className="space-y-4">
                            <form onSubmit={(e) => {e.preventDefault(); if(newTask) {setTasks([...tasks, {id: Date.now(), text: newTask, completed: false}]); setNewTask('');}}} className="flex gap-2">
                                <input type="text" value={newTask} onChange={e => setNewTask(e.target.value)} placeholder="Objective..." className="flex-1 bg-zinc-900/40 border border-zinc-900 rounded-xl px-4 py-3 text-sm text-zinc-200 outline-none focus:border-zinc-700" />
                                <button className="bg-zinc-800 px-4 rounded-xl text-zinc-400">+</button>
                            </form>
                            <div className="space-y-2">
                                {tasks.map(t => (
                                    <div key={t.id} className={`flex items-center gap-3 p-4 rounded-xl border transition-opacity ${t.completed ? 'opacity-30 border-transparent' : 'bg-zinc-900/20 border-zinc-900'}`}>
                                        <button onClick={() => setTasks(tasks.map(tk => tk.id === t.id ? {...tk, completed: !tk.completed} : tk))} className="text-zinc-600">
                                            <i data-lucide={t.completed ? "check-circle-2" : "circle"}></i>
                                        </button>
                                        <span className="text-sm flex-1">{t.text}</span>
                                        <button onClick={() => setTasks(tasks.filter(tk => tk.id !== t.id))} className="text-zinc-800"><i data-lucide="trash-2" size="14"></i></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>